language: python
python:
  - "3.11"

services:
  - docker

env:
  global:
    - DOCKER_IMAGE_NAME=chandanmalakar/lexora-pdf-chat
    - DOCKER_IMAGE_TAG=latest
    - secure: "YOUR_DOCKER_USERNAME_ENCRYPTED"  # Add via travis encrypt
    - secure: "YOUR_DOCKER_PASSWORD_ENCRYPTED"  # Add via travis encrypt

before_install:
  - echo "Starting Travis CI/CD Pipeline"
  - python --version
  - pip install --upgrade pip

install:
  - echo "Installing dependencies..."
  - pip install -r requirements.txt
  - pip install pytest pytest-cov python-dotenv

before_script:
  - echo "Setting up test environment..."
  - mkdir -p logs
  - mkdir -p data
  - mkdir -p uploads
  - mkdir -p chroma_db

script:
  - echo "Running tests..."
  - python -m pytest tests/ -v --cov=src --cov-report=xml

after_success:
  - echo "Tests passed! Building Docker image..."
  - docker build -t $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG .
  - docker tag $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG $DOCKER_IMAGE_NAME:$TRAVIS_COMMIT
  
  - echo "Logging into Docker Hub..."
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  
  - echo "Pushing Docker images to Docker Hub..."
  - docker push $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG
  - docker push $DOCKER_IMAGE_NAME:$TRAVIS_COMMIT
  
  - echo "Docker images pushed successfully"

# Optional: Deploy to production (Railway, Render, or AWS)
deploy:
  - provider: script
    skip_cleanup: true
    script: bash scripts/deploy.sh
    on:
      branch: main
      condition: $TRAVIS_TEST_RESULT = 0

notifications:
  email:
    on_success: change
    on_failure: always
  slack:
    secure: "YOUR_SLACK_WEBHOOK_ENCRYPTED"  # Optional: Add via travis encrypt

branches:
  only:
    - main

cache:
  pip: true
  directories:
    - venv
    - chroma_db
